<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-section h2 {
            color: #495057;
            margin-bottom: 20px;
            text-align: center;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
            cursor: pointer;
        }

        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .upload-btn {
            display: block;
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .image-preview {
            margin-top: 20px;
            text-align: center;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .options-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
        }

        .options-section h2 {
            color: #495057;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group textarea,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group textarea:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .process-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .process-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .results-section h2 {
            color: #495057;
            margin-bottom: 20px;
        }

        .result-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin-top: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            margin-top: 20px;
        }

        .download-btn {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .history-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .history-section h2 {
            color: #495057;
            margin-bottom: 20px;
        }

        .history-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .history-item h4 {
            color: #495057;
            margin-bottom: 5px;
        }

        .history-item p {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .search-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .search-section h2 {
            color: #495057;
            margin-bottom: 20px;
            text-align: center;
        }

        .search-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .search-input-group {
            display: flex;
            width: 100%;
            max-width: 600px;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-btn {
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .search-options {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #495057;
            font-weight: 600;
        }

        .search-options select {
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .search-results {
            margin-top: 30px;
        }

        .search-results h3 {
            color: #495057;
            margin-bottom: 20px;
            text-align: center;
        }

        .search-result-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .search-result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .search-result-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .search-result-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .search-result-meta {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .search-result-score {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .search-result-context {
            color: #495057;
            line-height: 1.5;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        .search-loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .search-summary {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }

        .summary-stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #495057;
            font-size: 1rem;
        }

        .stat-item strong {
            color: #667eea;
            font-size: 1.2rem;
        }

        .footer {
            background: #343a40;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 30px;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>AI _ Image DRIVE</h1>
            <div style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">
                <span id="storageInfo">Storage: Checking...</span>
                <button onclick="checkStorageUsage()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 2px 8px; border-radius: 3px; cursor: pointer; margin-left: 10px; font-size: 0.8rem;">
                    üîÑ Refresh
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <h2>üì§ Upload Images</h2>
                <div class="file-upload">
                    <input type="file" id="imageInput" accept="image/*" multiple onchange="previewImages(event)">
                    <label for="imageInput" class="upload-btn">
                        üìÅ Choose Image Files (Multiple)
                    </label>
                </div>
                <div class="image-preview" id="imagePreview"></div>
                <div class="upload-info" id="uploadInfo" style="display: none;">
                    <p><strong>Selected:</strong> <span id="imageCount">0</span> images</p>
                    <p><strong>Total size:</strong> <span id="totalSize">0</span> MB</p>
                </div>
            </div>

            <div class="options-section">
                <h2>‚öôÔ∏è Analysis Options</h2>
                <div class="form-group">
                    <label for="customPrompt">Custom Analysis Prompt:</label>
                    <textarea id="customPrompt"
                        placeholder="Dynamic Universal Image Analysis Prompt - Comprehensive 10-step analysis including OCR, object recognition, people analysis, context, brands, aesthetics, cultural references, metadata, and human-friendly summary."># Universal Enhanced Image Analysis Prompt

                        ## System Role
                        You are an expert multimodal AI analyst specializing in exhaustive image interpretation, cross-referencing, and contextual reasoning. Your mission is to extract maximum insight from visual content through systematic analysis, web research validation, and comprehensive reporting.
                        
                        ## Core Analysis Framework
                        
                        ### Phase 1: Foundational Visual Processing
                        
                        **1.1 Complete Text Extraction & OCR++**
                        - Extract ALL visible text regardless of size, clarity, orientation, or distortion
                        - Capture: printed text, handwritten notes, stylized fonts, watermarks, logos, signs, labels
                        - Preserve exact formatting: line breaks, indentation, table structures, bullet points
                        - Include partial/cropped text with [PARTIAL] notation
                        - Detect language(s) and provide translations if non-English
                        - Note text hierarchy (headlines, subtext, captions, fine print)
                        
                        **1.2 Comprehensive Object & Scene Inventory**
                        - Catalog every identifiable object, tool, item, structure, or element
                        - Specify spatial relationships: foreground/background, left/right, above/below
                        - Describe physical properties: size, condition, age, materials
                        - Note interactions between objects and environmental context
                        - Classify scene type: indoor/outdoor, natural/artificial, public/private, formal/casual
                        
                        **1.3 Human Subject Analysis**
                        - Demographics: apparent age ranges, gender presentation, ethnicity (when relevant)
                        - Physical attributes: clothing, accessories, hairstyles, notable features
                        - Behavioral cues: postures, gestures, facial expressions, apparent emotions
                        - Social dynamics: relationships, hierarchies, group interactions
                        - Professional/role indicators: uniforms, badges, equipment
                        
                        ### Phase 2: Identity & Recognition Systems
                        
                        **2.1 Enhanced Public Figure & Key Person Identification**
                        - **Systematic Recognition Process**:
                          - Analyze facial features, distinctive characteristics, and body language
                          - Note clothing, accessories, or items that might indicate profession/role
                          - Look for name tags, badges, or identifying text
                          - Consider context clues (venue, other people present, event type)
                        
                        - **Multi-Level Identification Strategy**:
                          - **Level 1**: Immediate recognition of globally famous figures
                          - **Level 2**: Industry-specific celebrities (sports, politics, entertainment, business)
                          - **Level 3**: Regional or niche public figures
                          - **Level 4**: Professional or contextual roles (officials, speakers, organizers)
                        
                        - **Confidence Scoring with Evidence**:
                          - **High Confidence (90%+)**: Multiple distinctive features match, confirmed by context
                          - **Medium Confidence (60-89%)**: Strong resemblance with supporting context clues
                          - **Low Confidence (30-59%)**: Possible match requiring verification
                          - **Uncertain (<30%)**: Insufficient visual information for identification
                        
                        - **Mandatory Verification for Event Context**:
                          - If any person is identified, immediately search: "[Person name] + [date range] + [location/venue]"
                          - Cross-reference their public schedule, social media, or news coverage
                          - Look for other attendees or participants who might be visible
                          - Verify their connection to the suspected event type
                        
                        **2.2 Brand & Commercial Recognition**
                        - Identify corporate logos, brand marks, product packaging, store signage
                        - Classify industries: technology, fashion, automotive, food/beverage, entertainment, etc.
                        - Note brand positioning (luxury, mainstream, budget) and target demographics
                        - Recognize sponsored content or product placement
                        
                        ## Enhanced Event Detection Examples & Strategies
                        
                        ### Critical Visual Indicators for Major Event Types:
                        
                        **Political Events:**
                        - Look for: Government seals, political party logos, campaign banners, podiums with official insignia
                        - Search strategy: "[Visible text/logos] + political event + [timeframe]"
                        - Key figures: Politicians, government officials, campaign staff
                        
                        **Award Shows & Entertainment:**
                        - Look for: Red carpets, step-and-repeat backgrounds, trophy imagery, entertainment venue architecture
                        - Search strategy: "[Venue name/distinctive backdrop] + award show + [year]"
                        - Key figures: Celebrities, presenters, industry professionals
                        
                        **Sports Events:**
                        - Look for: Team uniforms, stadium features, scoreboards, sports equipment, crowd formations
                        - Search strategy: "[Team colors/logos] + [sport type] + [venue] + [date]"
                        - Key figures: Athletes, coaches, officials, commentators
                        
                        **Corporate/Business Events:**
                        - Look for: Company logos, conference staging, business attire, name badges, presentation screens
                        - Search strategy: "[Company logo] + conference/event + [location] + [year]"
                        - Key figures: Executives, speakers, industry leaders
                        
                        **Cultural/Social Events:**
                        - Look for: Cultural symbols, traditional dress, ceremonial objects, festival decorations
                        - Search strategy: "[Cultural elements] + [location] + festival/celebration + [timeframe]"
                        - Key figures: Community leaders, performers, dignitaries
                        
                        ### Mandatory Search Queries for Event Identification:
                        1. **Exact text extraction search**: Search any readable text verbatim
                        2. **Visual similarity search**: Use reverse image search tools
                        3. **Contextual combination search**: "[Key person] + [location] + [event type] + [date range]"
                        4. **News archive search**: "[Suspected event] + news + [timeframe]"
                        5. **Social media hashtag search**: Look for event-specific hashtags or trending topics
                        
                        **3.1 Advanced Event & Situational Context Detection**
                        - **Primary Event Classification**: Systematically analyze visual cues to determine event type:
                          - Sports events: Look for uniforms, team colors, stadiums, scoreboards, crowds, equipment
                          - Political events: Identify podiums, flags, campaign materials, government buildings, official ceremonies
                          - Entertainment: Stage lighting, performers, audiences, venues, red carpets, award shows
                          - Educational: Classrooms, graduation caps, academic regalia, school logos, learning materials
                          - Religious: Ceremonial objects, religious symbols, traditional dress, places of worship
                          - Corporate: Business attire, conference settings, company logos, networking events
                          - Social celebrations: Decorations, cake, formal wear, gift wrapping, party supplies
                          - News events: Media presence, breaking news overlays, emergency vehicles, crowds
                        
                        - **Event-Specific Visual Markers**: Look for distinctive elements that pinpoint exact events:
                          - Venue architecture and distinctive features
                          - Specific logos, banners, or signage with event names/dates
                          - Unique staging, decorations, or branding
                          - Celebrity attendees or notable figures
                          - Broadcast graphics or media watermarks
                          - Crowd size and composition patterns
                          - Security or staff uniforms and equipment
                        
                        - **Temporal and Geographic Context Clues**:
                          - Weather conditions and seasonal indicators
                          - Architectural styles specific to regions
                          - Language on signs and cultural dress
                          - Technology visible (phones, cameras, screens) to estimate time period
                          - Fashion trends and styles to narrow timeframe
                          - Currency, license plates, or regional symbols
                        
                        - **Cross-Reference Strategy for Event Identification**:
                          - If you identify potential event markers, IMMEDIATELY search for:
                            - "Event name + date + location" if any are visible
                            - Notable attendees + event type + timeframe
                            - Venue name + event type + recent dates
                            - Unique visual elements + event context
                          - Search for reverse image matches to find original source and context
                          - Look up news coverage from the apparent timeframe
                          - Verify through multiple independent sources
                        
                        **3.2 Systematic Web Research & Event Verification Protocol**
                        *Execute this enhanced search strategy for event identification:*
                        
                        **Step 1: Visual Element Extraction**
                        - Catalog ALL text visible in the image (signs, banners, screens, clothing, etc.)
                        - Note distinctive objects, symbols, or branding elements
                        - Identify any people who might be recognizable
                        - Document unique architectural or venue features
                        
                        **Step 2: Multi-Vector Search Approach**
                        - **Text-based searches**: Search exact phrases found in the image
                        - **Visual similarity search**: Look for identical or similar images
                        - **Entity combination searches**: Combine identified people + location + context
                        - **Reverse chronological search**: If timeframe is suspected, search that period
                        - **News verification**: Cross-check against news archives and media coverage
                        
                        **Step 3: Event Database Cross-Reference**
                        Search specific databases and sources:
                        - Major news outlets for the suspected timeframe
                        - Event venue websites and social media accounts
                        - Celebrity/public figure social media and news coverage
                        - Sports databases, award show archives, political event records
                        - Social media hashtags and trending topics from the period
                        
                        **Step 4: Validation and Confirmation**
                        - Require at least 2-3 independent sources confirming the same event
                        - Look for official documentation or press releases
                        - Verify attendee lists or participant rosters
                        - Cross-check dates, locations, and other factual details
                        - Flag any conflicting information or uncertainty
                        
                        **3.3 Platform & Media Type Detection**
                        - Identify source platform: Instagram, Twitter/X, TikTok, LinkedIn, news sites, etc.
                        - Recognize UI elements, platform-specific features, interaction buttons
                        - Note screenshot artifacts, mobile/desktop indicators
                        - Detect editing or filtering applied
                        
                        ### Phase 4: Technical & Aesthetic Analysis
                        
                        **4.1 Visual Composition & Style**
                        - Color palette: dominant/accent colors with hex codes when possible
                        - Artistic style: photographic, illustrated, vintage, modern, minimalist, maximalist
                        - Composition techniques: rule of thirds, leading lines, symmetry, framing
                        - Lighting analysis: natural/artificial, direction, mood, quality
                        
                        **4.2 Technical Metadata Inference**
                        - Image source: photograph, screenshot, scan, digital artwork, AI-generated
                        - Camera/device indicators: quality, perspective, lens effects
                        - Editing evidence: filters, retouching, composite elements
                        - Resolution and quality assessment
                        
                        ### Phase 5: Cultural & Historical Context
                        
                        **5.1 Cultural Significance & References**
                        - Identify cultural symbols, traditions, or practices
                        - Recognize historical periods, architectural styles, fashion eras
                        - Note religious, political, or social symbolism
                        - Detect references to pop culture, literature, or art
                        
                        **5.2 Meme & Viral Content Recognition**
                        - Identify known memes, viral images, or internet phenomena
                        - Explain cultural significance and typical usage
                        - Trace origin story and evolution if known
                        - Note current relevance or trending status
                        
                        ### Phase 6: Security & Privacy Considerations
                        
                        **6.1 Sensitive Information Detection**
                        - Flag visible personal data: phone numbers, emails, addresses, IDs
                        - Note security badges, access cards, or confidential markings
                        - Identify potential privacy concerns or OPSEC issues
                        - Highlight any legal or safety implications
                        
                        ### Phase 7: Comprehensive Synthesis
                        
                        **7.1 Purpose & Intent Analysis**
                        - Determine likely image purpose: documentation, marketing, personal, news, evidence
                        - Assess target audience and intended message
                        - Note emotional tone and psychological impact
                        - Suggest optimal categorization tags
                        
                        **7.2 Event-Focused Rich Narrative Description**
                        Provide a detailed, accessible description that:
                        - **Event Context First**: Lead with the identified event and its significance
                        - **Timeline Placement**: Establish when and where this event occurred
                        - **Key Participants**: Explain who is present and their roles/importance
                        - **Event Significance**: Describe why this event matters historically, culturally, or socially
                        - **Visual Story**: Tell what's happening in the moment captured
                        - **Broader Impact**: Connect to larger themes, consequences, or related events
                        - **Verification Status**: Clearly state confidence level and sources used for identification
                        
                        **7.3 Event Identification Confidence Matrix**
                        Rate event identification confidence:
                        - **Confirmed Event (95-100%)**: Multiple sources verify exact event, date, location
                        - **Highly Likely Event (80-94%)**: Strong evidence with minor gaps in verification
                        - **Probable Event (60-79%)**: Good contextual match but requires more confirmation
                        - **Possible Event (40-59%)**: Some indicators but significant uncertainty remains
                        - **Unknown Event (0-39%)**: Insufficient evidence for specific event identification
                        
                        **Always include:**
                        - Specific search terms used for verification
                        - Sources that confirmed or contradicted the identification
                        - Alternative possibilities if primary identification is uncertain
                        - Gaps in evidence that prevent higher confidence rating
                        
                        ## Output Format Guidelines
                        
                        - Use clear headings and structured organization
                        - Provide specific evidence for all claims
                        - Include relevant quotes of extracted text
                        - Use bullet points for inventory-style information
                        - Write flowing paragraphs for narrative sections
                        - Always cite web sources when used for verification
                        - Flag urgent or sensitive findings prominently
                        
                        ## Quality Assurance Protocols
                        
                        - Cross-verify major identifications through multiple approaches
                        - Question initial assumptions and consider alternative interpretations
                        - Prioritize accuracy over speculation
                        - Distinguish between direct observation and inference
                        - Update analysis if web research reveals contradictory information
                        
                        ---
                        
                        *Remember: This analysis should be thorough but respectful of privacy, accurate but acknowledging uncertainty, and comprehensive while remaining accessible to human readers.*</textarea>
                </div>
                <div class="form-group">
                    <label for="customFilename">Custom JSON Filename (Optional):</label>
                    <input type="text" id="customFilename" placeholder="my_image_analysis">
                </div>
                <button class="process-btn" onclick="processImage()" id="processBtn" disabled>
                    üöÄ Process Images with Gemini
                </button>
            </div>
        </div>

        <div class="search-section">
            <h2>üîç Search Photos <span style="font-size: 0.8rem; color: #667eea; background: rgba(102, 126, 234, 0.1); padding: 4px 8px; border-radius: 12px; margin-left: 10px;">ü§ñ AI-Powered</span></h2>
            <div class="search-container">
                <div class="search-input-group">
                    <input type="text" id="searchInput" placeholder="Describe what you're looking for..."
                        class="search-input">
                    <button onclick="searchImages()" class="search-btn">üîç Search</button>
                </div>
                <div class="search-options">
                    <label for="maxResults">Max Results:</label>
                    <select id="maxResults">
                        <option value="3">3</option>
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                    </select>
                    <div style="margin-left: 15px; padding: 5px 10px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 0.9rem; color: #667eea;">
                        ü§ñ AI Search Active
                    </div>
                </div>
            </div>
            <div class="search-summary" id="searchSummary" style="display: none;">
                <div class="summary-stats">
                    <span class="stat-item">üìä <strong id="totalBatches">0</strong> batches</span>
                    <span class="stat-item">üñºÔ∏è <strong id="totalImages">0</strong> images</span>
                    <span class="stat-item">üïí Last updated: <span id="lastUpdated">Never</span></span>
                    <span class="stat-item">ü§ñ <strong id="aiSearchStatus">AI Active</strong></span>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="showAllBatches()" class="search-btn" style="background: #28a745;">
                        üìã View All Batches
                    </button>
                    <button onclick="toggleSearchMode()" class="search-btn" style="background: #ffc107; color: #000; margin-left: 10px;">
                        üîÑ Toggle Search Mode
                    </button>
                </div>
            </div>
            <div class="search-results" id="searchResults" style="display: none;">
                <h3>Search Results</h3>
                <div id="searchResultsContent"></div>
            </div>
            
            <div class="search-status" id="searchStatus" style="display: none; text-align: center; margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px;">
                <div class="spinner" style="width: 30px; height: 30px; border-top-color: #667eea;"></div>
                <p style="margin-top: 10px; color: #667eea; font-weight: 600;">ü§ñ AI is analyzing your search query with Gemini 2.5 Pro...</p>
                <p style="font-size: 0.9rem; color: #6c757d;">This may take a few seconds for complex queries</p>
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <h2>üìä Analysis Results</h2>
            <div style="text-align: right; margin-bottom: 15px;">
                <button onclick="showHistory()" style="background: #667eea; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">
                    üìã Show History
                </button>
            </div>
            <div id="resultsContent"></div>
        </div>

        <div class="history-section" id="historySection" style="display: none;">
            <h2>üìã Processing History</h2>
            <div style="text-align: right; margin-bottom: 15px;">
                <button onclick="clearStorage()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9rem;">
                    üóëÔ∏è Clear Storage
                </button>
            </div>
            <div id="historyContent"></div>
        </div>

        <div class="footer">
            <p><strong>Powered by:</strong> <a href="https://sagarteotia.in" target="_blank">sagarteotia.in</a></p>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let processingHistory = [];

        function previewImages(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                selectedFiles = files;

                // Update upload info
                const imageCount = document.getElementById('imageCount');
                const totalSize = document.getElementById('totalSize');
                const uploadInfo = document.getElementById('uploadInfo');

                imageCount.textContent = files.length;
                const totalSizeMB = (files.reduce((sum, file) => sum + file.size, 0) / (1024 * 1024)).toFixed(2);
                totalSize.textContent = totalSizeMB;
                uploadInfo.style.display = 'block';

                // Create preview grid
                const preview = document.getElementById('imagePreview');
                let previewHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">';

                files.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewHTML += `
                            <div style="text-align: center;">
                                <img src="${e.target.result}" alt="Preview ${index + 1}" style="max-width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #dee2e6;">
                                <p style="font-size: 0.8rem; margin-top: 5px; color: #6c757d;">${file.name}</p>
                            </div>
                        `;

                        // Update preview when all images are loaded
                        if (index === files.length - 1) {
                            preview.innerHTML = previewHTML + '</div>';
                        }
                    };
                    reader.readAsDataURL(file);
                });

                document.getElementById('processBtn').disabled = false;
            }
        }

        async function processImage() {
            if (!selectedFiles || selectedFiles.length === 0) {
                alert('Please select at least one image first!');
                return;
            }

            const processBtn = document.getElementById('processBtn');
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');

            // Show loading state
            processBtn.disabled = true;
            processBtn.textContent = 'üîÑ Processing...';
            resultsSection.style.display = 'block';
            resultsContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Processing ${selectedFiles.length} image${selectedFiles.length > 1 ? 's' : ''} with Gemini 2.5 Pro...</p>
                </div>
            `;

            try {
                // Create FormData for file upload
                const formData = new FormData();

                // Add all selected files
                selectedFiles.forEach(file => {
                    formData.append('images', file);
                });

                formData.append('prompt', document.getElementById('customPrompt').value);
                formData.append('filename', document.getElementById('customFilename').value);

                // Send to backend for actual Gemini processing
                const response = await fetch('/process-image', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Display successful results
                    displayResults(result.result);
                    // Add to history
                    addToHistory(result.result);
                } else {
                    // Display error results
                    displayResults(result.result);
                }
                
                // Check storage usage after processing
                checkStorageUsage();

            } catch (error) {
                console.error('Processing error:', error);
                resultsContent.innerHTML = `
                    <div class="error">
                        <strong>‚ùå Processing failed:</strong> ${error.message}
                        <br><br>
                        <small>Check the server logs for more details.</small>
                    </div>
                `;
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'üöÄ Process Images with Gemini';
            }
        }



        function displayResults(result) {
            const resultsContent = document.getElementById('resultsContent');

            // Check if this is a batch result
            if (result.images && Array.isArray(result.images)) {
                displayBatchResults(result);
                return;
            }

            // Handle single image result (backward compatibility)
            displaySingleImageResult(result);
        }

        function displayBatchResults(batchResult) {
            const resultsContent = document.getElementById('resultsContent');

            const totalImages = batchResult.total_images || 0;
            const successfulImages = batchResult.successful_images || 0;
            const failedImages = batchResult.failed_images || 0;
            const batchSummary = batchResult.batch_summary || '';
            const status = batchResult.processing_status || 'unknown';

            let resultsHTML = `
                <div class="result-content">
                    <div class="${status === 'completed' ? 'success' : 'error'}">
                        <strong>${status === 'completed' ? '‚úÖ' : '‚ùå'} Batch Processing ${status === 'completed' ? 'Completed' : 'Failed'}</strong>
                    </div>
                    
                    <h3>Batch Analysis Results</h3>
                    <p><strong>Total Images:</strong> ${totalImages}</p>
                    <p><strong>Successful:</strong> ${successfulImages}</p>
                    <p><strong>Failed:</strong> ${failedImages}</p>
                    <p><strong>Summary:</strong> ${batchSummary}</p>
                    <p><strong>Timestamp:</strong> ${new Date(batchResult.batch_timestamp).toLocaleString()}</p>
                    
                    <h4>Individual Image Results:</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
            `;

            batchResult.images.forEach((imageResult, index) => {
                const imageName = imageResult.image_name || 'Unknown';
                const imageSize = imageResult.image_size || { width: 0, height: 0, format: 'Unknown' };
                const context = imageResult.context || 'No context available';
                const imgStatus = imageResult.processing_status || 'unknown';
                const uploadPath = imageResult.upload_path || 'Not saved';

                resultsHTML += `
                    <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 10px 0; background: ${imgStatus === 'success' ? '#f8f9fa' : '#fff5f5'}">
                        <h5 style="margin: 0 0 10px 0; color: ${imgStatus === 'success' ? '#28a745' : '#dc3545'}">
                            ${imgStatus === 'success' ? '‚úÖ' : '‚ùå'} ${imageName}
                        </h5>
                        <p><strong>Size:</strong> ${imageSize.width} √ó ${imageSize.height} (${imageSize.format})</p>
                        <p><strong>Status:</strong> ${imgStatus}</p>
                        <p><strong>Upload Path:</strong> ${uploadPath}</p>
                        ${imgStatus === 'success' ? `<p><strong>Context:</strong> ${context.substring(0, 200)}${context.length > 200 ? '...' : ''}</p>` : ''}
                    </div>
                `;
            });

            resultsHTML += `
                    </div>
                    
                    <button class="download-btn" onclick="downloadJSON(${JSON.stringify(batchResult).replace(/"/g, '&quot;')})">
                        üì• Download Batch JSON
                    </button>
                </div>
            `;

            resultsContent.innerHTML = resultsHTML;
        }

        function displaySingleImageResult(result) {
            const resultsContent = document.getElementById('resultsContent');

            // Safely access properties with fallbacks
            const imageName = result.image_name || 'Unknown';
            const imageSize = result.image_size || { width: 0, height: 0, format: 'Unknown' };
            const timestamp = result.timestamp || new Date().toISOString();
            const context = result.context || 'No context available';
            const status = result.processing_status || 'unknown';
            const uploadPath = result.upload_path || 'Not saved';

            if (status === 'success') {
                resultsContent.innerHTML = `
                    <div class="result-content">
                        <div class="success">
                            <strong>‚úÖ Image processed successfully!</strong>
                        </div>
                        
                        <h3>Analysis Results</h3>
                        <p><strong>Image:</strong> ${imageName}</p>
                        <p><strong>Size:</strong> ${imageSize.width} √ó ${imageSize.height}</p>
                        <p><strong>Format:</strong> ${imageSize.format}</p>
                        <p><strong>Timestamp:</strong> ${new Date(timestamp).toLocaleString()}</p>
                        <p><strong>Upload Path:</strong> ${uploadPath}</p>
                        
                        <h4>Context Analysis:</h4>
                        <p>${context}</p>
                        
                        <button class="download-btn" onclick="downloadJSON(${JSON.stringify(result).replace(/"/g, '&quot;')})">
                            üì• Download JSON
                        </button>
                    </div>
                `;
            } else {
                // Handle error case
                const errorMessage = result.error || 'Unknown error occurred';
                resultsContent.innerHTML = `
                    <div class="result-content">
                        <div class="error">
                            <strong>‚ùå Processing failed:</strong> ${errorMessage}
                        </div>
                        
                        <h3>Error Details</h3>
                        <p><strong>Image:</strong> ${imageName}</p>
                        <p><strong>Size:</strong> ${imageSize.width} √ó ${imageSize.height}</p>
                        <p><strong>Format:</strong> ${imageSize.format}</p>
                        <p><strong>Timestamp:</strong> ${new Date(timestamp).toLocaleString()}</p>
                        <p><strong>Upload Path:</strong> ${uploadPath}</p>
                        
                        <h4>Error Information:</h4>
                        <p>${context}</p>
                    </div>
                `;
            }
        }

        function downloadJSON(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `image_analysis_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function addToHistory(result) {
            // Create a lightweight history item with only essential data
            const historyItem = {
                id: Date.now(),
                image_name: result.image_name || 'Unknown',
                processing_status: result.processing_status || 'unknown',
                timestamp: result.timestamp || new Date().toISOString(),
                // Only store a small preview of context to save space
                context_preview: result.context ? result.context.substring(0, 100) + '...' : 'No context'
            };

            processingHistory.unshift(historyItem);

            // Keep only last 10 items
            if (processingHistory.length > 10) {
                processingHistory = processingHistory.slice(0, 10);
            }

            // Try to save to localStorage with error handling
            try {
                localStorage.setItem('imageAnalysisHistory', JSON.stringify(processingHistory));
            } catch (error) {
                console.warn('Failed to save to localStorage (quota exceeded):', error);
                // If localStorage is full, clear it and try to save just the current item
                try {
                    localStorage.clear();
                    localStorage.setItem('imageAnalysisHistory', JSON.stringify([historyItem]));
                } catch (clearError) {
                    console.error('Failed to clear localStorage:', clearError);
                    // If still failing, don't save history
                }
            }
        }

        function showHistory() {
            const historySection = document.getElementById('historySection');
            const historyContent = document.getElementById('historyContent');

            if (historySection.style.display === 'none') {
                historySection.style.display = 'block';

                if (processingHistory.length === 0) {
                    historyContent.innerHTML = '<p>No processing history found.</p>';
                } else {
                    let historyHTML = '';
                    processingHistory.forEach((item, index) => {
                        historyHTML += `
                            <div class="history-item" onclick="showHistoryItem(${index})">
                                <h4>üì∏ ${item.image_name}</h4>
                                <p><strong>Status:</strong> ${item.processing_status}</p>
                                <p><strong>Timestamp:</strong> ${new Date(item.timestamp).toLocaleString()}</p>
                            </div>
                        `;
                    });
                    historyContent.innerHTML = historyHTML;
                }
            } else {
                historySection.style.display = 'none';
            }
        }

        function showHistoryItem(index) {
            const item = processingHistory[index];
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');

            resultsSection.style.display = 'block';
            displayResults(item);

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Load history from localStorage on page load
        window.onload = function () {
            try {
                const savedHistory = localStorage.getItem('imageAnalysisHistory');
                if (savedHistory) {
                    processingHistory = JSON.parse(savedHistory);
                }
            } catch (error) {
                console.warn('Failed to load history from localStorage:', error);
                // Clear corrupted localStorage and start fresh
                try {
                    localStorage.clear();
                    processingHistory = [];
                } catch (clearError) {
                    console.error('Failed to clear localStorage:', clearError);
                }
            }
            
            // Check storage usage on page load
            setTimeout(checkStorageUsage, 500);
            
            // Load saved search mode
            loadSearchMode();
        };
        
        // Function to load saved search mode
        function loadSearchMode() {
            const savedMode = localStorage.getItem('searchMode');
            if (savedMode === 'keyword') {
                toggleSearchMode(); // This will switch to keyword mode
            }
        }

        // Function to clear localStorage manually if needed
        function clearStorage() {
            try {
                localStorage.clear();
                processingHistory = [];
                alert('Storage cleared successfully!');
                // Refresh the page to show updated state
                location.reload();
            } catch (error) {
                console.error('Failed to clear storage:', error);
                alert('Failed to clear storage. Please try refreshing the page.');
            }
        }

        // Function to check storage usage
        function checkStorageUsage() {
            try {
                let totalSize = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        totalSize += localStorage[key].length;
                    }
                }
                const sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
                
                // Update the storage info display
                const storageInfo = document.getElementById('storageInfo');
                if (storageInfo) {
                    if (totalSize > 4 * 1024 * 1024) {
                        storageInfo.innerHTML = `Storage: <span style="color: #ffc107;">‚ö†Ô∏è ${sizeInMB}MB (High)</span>`;
                        storageInfo.title = 'Storage usage is high. Consider clearing storage.';
                    } else if (totalSize > 2 * 1024 * 1024) {
                        storageInfo.innerHTML = `Storage: <span style="color: #ffc107;">${sizeInMB}MB (Medium)</span>`;
                        storageInfo.title = 'Storage usage is moderate.';
                    } else {
                        storageInfo.innerHTML = `Storage: <span style="color: #90EE90;">${sizeInMB}MB (Good)</span>`;
                        storageInfo.title = 'Storage usage is good.';
                    }
                }
                
                // Warn if storage is getting full (over 4MB)
                if (totalSize > 4 * 1024 * 1024) {
                    console.warn(`Storage usage: ${sizeInMB}MB - Consider clearing storage`);
                    return { size: sizeInMB, warning: true };
                }
                return { size: sizeInMB, warning: false };
            } catch (error) {
                console.error('Failed to check storage usage:', error);
                const storageInfo = document.getElementById('storageInfo');
                if (storageInfo) {
                    storageInfo.innerHTML = 'Storage: <span style="color: #dc3545;">Error</span>';
                }
                return { size: 'Unknown', warning: false };
            }
        }

        // Search functionality
        async function searchImages() {
            const searchInput = document.getElementById('searchInput');
            const maxResults = document.getElementById('maxResults');
            const searchResults = document.getElementById('searchResults');
            const searchResultsContent = document.getElementById('searchResultsContent');

            if (!searchInput.value.trim()) {
                alert('Please enter a search query!');
                return;
            }

                    // Check search mode
        const searchMode = localStorage.getItem('searchMode') || 'ai';
        const isAISearch = searchMode === 'ai';
        
        // Show appropriate search status
        const searchStatus = document.getElementById('searchStatus');
        if (isAISearch) {
            searchStatus.style.display = 'block';
            searchResultsContent.innerHTML = `
                <div class="search-loading">
                    <div class="spinner"></div>
                    <p>ü§ñ AI-powered search for "${searchInput.value}"...</p>
                    <p style="font-size: 0.9rem; color: #6c757d;">Using Gemini 2.5 Pro for semantic understanding</p>
                </div>
            `;
        } else {
            searchStatus.style.display = 'none';
            searchResultsContent.innerHTML = `
                <div class="search-loading">
                    <div class="spinner"></div>
                    <p>üîç Keyword search for "${searchInput.value}"...</p>
                    <p style="font-size: 0.9rem; color: #6c757d;">Using traditional keyword matching</p>
                </div>
            `;
        }
        
        // Show results section
        searchResults.style.display = 'block';

                    // Show summary section
        const searchSummary = document.getElementById('searchSummary');
        searchSummary.style.display = 'block';
        
        // Record search start time
        const searchStartTime = Date.now();

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: searchInput.value.trim(),
                        max_results: parseInt(maxResults.value)
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const searchTime = Date.now() - searchStartTime;

                if (result.success) {
                    displaySearchResults(result, searchTime);
                    // Hide AI search status
                    document.getElementById('searchStatus').style.display = 'none';
                } else {
                    searchResultsContent.innerHTML = `
                        <div class="error">
                            <strong>‚ùå Search failed:</strong> ${result.error || 'Unknown error'}
                        </div>
                    `;
                    // Hide AI search status
                    document.getElementById('searchStatus').style.display = 'none';
                }

            } catch (error) {
                console.error('Search error:', error);
                searchResultsContent.innerHTML = `
                    <div class="error">
                        <strong>‚ùå Search failed:</strong> ${error.message}
                        <br><br>
                        <small>Check the server logs for more details.</small>
                    </div>
                `;
                // Hide AI search status
                document.getElementById('searchStatus').style.display = 'none';
            }
        }

        function displaySearchResults(searchData, searchTime) {
            const searchResultsContent = document.getElementById('searchResultsContent');

            // Update summary information
            const totalBatches = document.getElementById('totalBatches');
            const totalImages = document.getElementById('totalImages');
            const lastUpdated = document.getElementById('lastUpdated');

            // Try to get summary info from the first result's source file
            if (searchData.results && searchData.results.length > 0) {
                const firstResult = searchData.results[0];
                const sourceFile = firstResult.source_file;

                // Load the source file to get summary info
                fetch(`/download/${sourceFile}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.content) {
                            try {
                                const jsonData = JSON.parse(data.content);
                                if (jsonData.batches) {
                                    totalBatches.textContent = jsonData.batches.length;
                                    totalImages.textContent = jsonData.total_images_processed || 0;
                                    lastUpdated.textContent = new Date(jsonData.last_updated || '').toLocaleString();
                                }
                            } catch (e) {
                                console.log('Could not parse summary data');
                            }
                        }
                    })
                    .catch(e => console.log('Could not load summary data'));
            }

            if (!searchData.results || searchData.results.length === 0) {
                searchResultsContent.innerHTML = `
                    <div class="no-results">
                        <p>No images found matching "${searchData.query}"</p>
                        <p>Try different keywords or check if you have processed images</p>
                    </div>
                `;
                return;
            }

            let resultsHTML = `
                <div class="search-summary">
                    <p><strong>Found ${searchData.total_found} images</strong> matching "${searchData.query}"</p>
                    <div style="margin-top: 10px; padding: 10px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border-left: 3px solid #667eea;">
                        <p style="margin: 0; font-size: 0.9rem; color: #667eea;">
                            <strong>ü§ñ AI Search Results:</strong> 
                            ${searchData.results.some(r => r.ai_reasoning && r.ai_reasoning !== 'Keyword-based fallback search') ? 
                                'AI-powered semantic analysis completed successfully' : 
                                'Using keyword-based fallback search'
                            }
                        </p>
                        <p style="margin: 5px 0 0 0; font-size: 0.8rem; color: #6c757d;">
                            ‚è±Ô∏è Search completed in ${searchTime}ms
                        </p>
                    </div>
                </div>
            `;

            searchData.results.forEach((result, index) => {
                const imageName = result.image_name || 'Unknown';
                const imageSize = result.image_size || { width: 0, height: 0, format: 'Unknown' };
                const context = result.context || 'No context available';
                const relevanceScore = result.relevance_score || 0;
                const timestamp = result.timestamp || 'Unknown';
                const imageUrl = result.image_url || '';
                const imageExists = result.image_exists || false;

                resultsHTML += `
                    <div class="search-result-item">
                        <div class="search-result-header">
                            ${imageExists && imageUrl ?
                        `<img src="${imageUrl}" alt="${imageName}" class="search-result-image">` :
                        `<div class="search-result-image" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #6c757d;">
                                    üì∑
                                </div>`
                    }
                            <div class="search-result-info">
                                <div class="search-result-title">${imageName}</div>
                                                                 <div class="search-result-meta">
                                     Size: ${imageSize.width} √ó ${imageSize.height} (${imageSize.format})<br>
                                     Date: ${new Date(timestamp).toLocaleString()}<br>
                                     Batch: ${result.batch_id || 'Unknown'}<br>
                                     Source: ${result.source_file || 'Unknown'}
                                 </div>
                            </div>
                            <div class="search-result-score">
                                ${Math.round(relevanceScore * 100)}% match
                            </div>
                        </div>
                        <div class="search-result-context">
                            <strong>Context:</strong> ${context.substring(0, 300)}${context.length > 300 ? '...' : ''}
                            ${result.ai_reasoning && result.ai_reasoning !== 'Keyword-based fallback search' ? 
                                `<br><br><strong>ü§ñ AI Reasoning:</strong> <span style="color: #667eea; font-style: italic;">${result.ai_reasoning}</span>` : 
                                ''
                            }
                        </div>
                    </div>
                `;
            });

            searchResultsContent.innerHTML = resultsHTML;
        }

        // Allow Enter key to trigger search
        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                searchImages();
            }
        });

        // Function to toggle between AI and keyword search modes
        function toggleSearchMode() {
            const aiStatus = document.getElementById('aiSearchStatus');
            const searchTitle = document.querySelector('.search-section h2');
            const searchIndicator = document.querySelector('.search-options div:last-child');
            
            if (aiStatus.textContent.includes('AI Active')) {
                // Switch to keyword mode
                aiStatus.innerHTML = '<strong>Keyword</strong>';
                aiStatus.style.color = '#ffc107';
                searchTitle.innerHTML = 'üîç Search Photos <span style="font-size: 0.8rem; color: #ffc107; background: rgba(255, 193, 7, 0.1); padding: 4px 8px; border-radius: 12px; margin-left: 10px;">üîç Keyword-Based</span>';
                searchIndicator.innerHTML = 'üîç Keyword Search';
                searchIndicator.style.background = 'rgba(255, 193, 7, 0.1)';
                searchIndicator.style.color = '#ffc107';
                localStorage.setItem('searchMode', 'keyword');
            } else {
                // Switch to AI mode
                aiStatus.innerHTML = '<strong>AI Active</strong>';
                aiStatus.style.color = '#667eea';
                searchTitle.innerHTML = 'üîç Search Photos <span style="font-size: 0.8rem; color: #667eea; background: rgba(102, 126, 234, 0.1); padding: 4px 8px; border-radius: 12px; margin-left: 10px;">ü§ñ AI-Powered</span>';
                searchIndicator.innerHTML = 'ü§ñ AI Search Active';
                searchIndicator.style.background = 'rgba(102, 126, 234, 0.1)';
                searchIndicator.style.color = '#667eea';
                localStorage.setItem('searchMode', 'ai');
            }
        }
        
        // Function to show all batches
        async function showAllBatches() {
            try {
                // Find the main JSON file (should be image_analysis_history.json)
                const response = await fetch('/download/image_analysis_history.json');
                if (!response.ok) {
                    alert('No batch history found. Process some images first!');
                    return;
                }

                const data = await response.json();
                if (data.success && data.content) {
                    const jsonData = JSON.parse(data.content);
                    displayAllBatches(jsonData);
                }
            } catch (error) {
                console.error('Error loading batches:', error);
                alert('Error loading batch history. Please try again.');
            }
        }

        function displayAllBatches(batchData) {
            const searchResults = document.getElementById('searchResults');
            const searchResultsContent = document.getElementById('searchResultsContent');

            searchResults.style.display = 'block';

            if (!batchData.batches || batchData.batches.length === 0) {
                searchResultsContent.innerHTML = `
                    <div class="no-results">
                        <p>No batches found</p>
                        <p>Process some images first to see batch history</p>
                    </div>
                `;
                return;
            }

            let resultsHTML = `
                <h3>üìã All Processing Batches</h3>
                <div class="search-summary">
                    <p><strong>Total Batches:</strong> ${batchData.batches.length}</p>
                    <p><strong>Total Images Processed:</strong> ${batchData.total_images_processed || 0}</p>
                    <p><strong>Last Updated:</strong> ${new Date(batchData.last_updated || '').toLocaleString()}</p>
                </div>
            `;

            batchData.batches.forEach((batch, batchIndex) => {
                const batchStatus = batch.processing_status || 'unknown';
                const batchSummary = batch.batch_summary || 'No summary available';
                const batchTimestamp = batch.batch_timestamp || batch.timestamp || 'Unknown';

                resultsHTML += `
                    <div class="search-result-item">
                        <div class="search-result-header">
                            <div class="search-result-image" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 2rem;">
                                üì¶
                            </div>
                            <div class="search-result-info">
                                <div class="search-result-title">Batch ${batch.batch_id || batchIndex + 1}</div>
                                <div class="search-result-meta">
                                    Status: ${batchStatus}<br>
                                    Images: ${batch.total_images || 0} total, ${batch.successful_images || 0} successful, ${batch.failed_images || 0} failed<br>
                                    Date: ${new Date(batchTimestamp).toLocaleString()}
                                </div>
                            </div>
                            <div class="search-result-score" style="background: ${batchStatus === 'completed' ? '#28a745' : '#dc3545'}">
                                ${batchStatus === 'completed' ? '‚úÖ' : '‚ùå'} ${batchStatus}
                            </div>
                        </div>
                        <div class="search-result-context">
                            <strong>Summary:</strong> ${batchSummary}
                        </div>
                    </div>
                `;
            });

            searchResultsContent.innerHTML = resultsHTML;
        }
    </script>
</body>

</html>